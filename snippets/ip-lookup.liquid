<script>
  document.addEventListener('DOMContentLoaded', function() {
    var thisUrl = new URL(location.href)
    var redirectParam = thisUrl.searchParams.get('userRedirect')
    var utmCampaignParam = thisUrl.searchParams.get('utm_campaign')
    var thisStore = '{{ detect_store }}'
    var htmlEl = document.querySelector('html')

    function setLocationCookie(location, locationState = false) {
      var today = new Date(Date.now())
      var oneDaysTime = new Date(today.getTime() + 24 * 60 * 60 * 1000)

      document.cookie = 'usrLocation='+location+'; expires='+oneDaysTime+'; path=/'

      if (locationState) {
        document.cookie = 'usrLocationState='+locationState+'; expires='+oneDaysTime+'; path=/'
      }
    }

    function autoRedirect(countryCode, stateCode) {
      var usrLocationCode = countryCode == 'GB' ? 'UK' : countryCode

      console.log(thisStore, usrLocationCode)

      if (thisStore !== usrLocationCode) {
        if (window.theme.helpers.euArray.indexOf(countryCode) > -1) {
          switch(countryCode) {
            case 'GB':
              window.location.href = 'https://uk.mous.co{{ request.path }}?userRedirect=' + countryCode
              break
            case 'FR':
              window.location.href = 'https://fr.mous.co{{ request.path }}?userRedirect=' + countryCode
              break
            case 'ES':
              window.location.href = 'https://es.mous.co{{ request.path }}?userRedirect=' + countryCode
              break
            default:
              if (thisStore === 'EU') {
                htmlEl.classList.add('geo-ready')

                return
              }

              window.location.href = 'https://eu.mous.co{{ request.path }}?userRedirect=' + countryCode
          }
        } else if (countryCode === 'US' && window.theme.helpers.usExcludedStates.indexOf(stateCode) <= -1) {
          if (thisStore === 'US') {
            htmlEl.classList.add('geo-ready')

            return
          }

          window.location.href = 'https://www.mous.co{{ request.path }}?userRedirect=' + countryCode
        } else {
          if (thisStore === 'ROW') {
            htmlEl.classList.add('geo-ready')

            return
          }

          window.location.href = 'https://row.mous.co{{ request.path }}?userRedirect=' + countryCode
        }
      } else {
        htmlEl.classList.add('geo-ready')
      }
    }

    if (redirectParam) {
      setLocationCookie(redirectParam)

      htmlEl.classList.add('geo-ready')
    } else if (window.theme.helpers.findCookie('usrLocation') == '') {
      var s = document.createElement('script')
      s.type = 'text/javascript'
      s.src = 'https://cdn.db-ip.com/js/dbip.js'
      s.dataset.apiKey = 'p6113008e3af5e579a227ad912a296241d242d06'
      document.querySelector('head').prepend(s)

      function dbipLoaded() {
        if (window.dbip) {
          dbip.getVisitorInfo()
            .then(function(info) {
              console.log('IP Lookup request successful, country code: ' + info.countryCode)

              setLocationCookie(info.countryCode, info.stateProvCode)

              // Don't redirect on DEV store
              {% if detect_store == 'DEV' %}
                htmlEl.classList.add('geo-ready')
              {% else %}
                // Don't redirect if coming from Google Shopping link
                if (utmCampaignParam == 'Google Shopping') {
                  htmlEl.classList.add('geo-ready')
                } else {
                  autoRedirect(info.countryCode, info.stateProvCode)
                }
              {% endif %}
            })
            .catch(err => {
              console.error(err)

              htmlEl.classList.add('geo-ready')
            })
        } else {
          setTimeout(dbipLoaded, 100)
        }
      }

      dbipLoaded()
    } else {
      htmlEl.classList.add('geo-ready')

      console.log('IP Lookup Bypassed')
    }

    if (window.theme.helpers.findCookie('usrLocation') === 'ROW') {
      var usrLocation = window.theme.helpers.findCookie('usrLocation')
      var iconFlag =  document.querySelector('#icon-flag')

      iconFlag.classList.remove('US')
      iconFlag.classList.add(usrLocation)
    }
  })
</script>
