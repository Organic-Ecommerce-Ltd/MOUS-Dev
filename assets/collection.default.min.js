window.theme.selectors.collection = {
  gridItem: '.grid-item[data-index]',
  gridItemTop: '[grid-item="top"]',
  gridItemOffersContainer: '[grid-item="offers-container"]',
  gridItemBottom: '[grid-item="bottom"]',
  gridGallery: '.grid-gallery',
  variantSelector: '.variant-selector',
  filterDevices: '.filter-device',
  filterLinks: '.filter-link',
  mobileFilterDropdowns: '.filter-mobile__dropdown-btn',
  filterShowMore: '.filter-level3-links__show',
  moreDetailsBtn: '[grid-item="more-details"]',
  submitCart: '.cart-submit',
  priceWrapper: '[grid-item="price-wrapper"]',
  price: '.product-info__price',
  priceCompare: '.product-info__price-compare',
  productURL: '.product-url',
  filterCancel: '[js-filter="clearAll"]',
  clarityCompatibilityWarning: '.product-info__compatibility-warning',
  preorderAlert: '.product-info__preorder',
  preorderDate: '[collection="preorder-date"]',
  viewItems: '[js-filter="viewItems"]',
  readMoreLink: '[collection="read-more"]',
  readMoreCopy: '[collection="read-more-copy"]',
  maxInCartMsg: '[collection="max-in-cart"]',
  stickyFilter: '.filter-sticky'
};
const readMoreLink = document.querySelector(window.theme.selectors.collection.readMoreLink);
const readMoreCopy = document.querySelector(window.theme.selectors.collection.readMoreCopy);

if (readMoreLink) {
  readMoreLink.addEventListener('click', e => {
    e.preventDefault();
    readMoreCopy.classList.toggle('dn');
    readMoreLink.innerText = `Read ${readMoreCopy.classList.contains('dn') ? 'More' : 'Less'}`;
  });
}
// Desktop show more btns on devices
const filterShowMore = document.querySelectorAll(window.theme.selectors.collection.filterShowMore);
const filterCancelLinks = document.querySelectorAll(window.theme.selectors.collection.filterCancel);
const filterStickyEl = document.querySelector(window.theme.selectors.collection.stickyFilter);
filterShowMore.forEach(showMoreLink => {
  showMoreLink.addEventListener('click', e => {
    e.preventDefault();
    let targetLink = e.target;
    document.querySelector(targetLink.hash).classList.remove('hide');
    targetLink.remove();
  });
});
/**
 * Filter URL Builder (uses: window.theme.collection.filterData)
 * Devices is 'or' filter
 * Range is 'or' filter
 * Materials is 'or' filter
 * @param {string} filterHandle data-filter-handle attribute of the clicked DOM element
 * @param {string} filterPretty data-filter-pretty attribute of the clicked DOM element
 * @param {string} filterType data-filter-type attribute clicked DOM element
 */

const filterURLBuilder = params => {
  const filterPretty = params.filterPretty;
  const filterType = params.filterType;
  const clearAll = params.clearAll;
  const thisFilterObj = window.theme.collection.filterData[filterType];
  let filterHandle = params.filterHandle;

  if (clearAll) {
    console.log('clearAll');
  } else {
    if (thisFilterObj.handle === filterHandle) {
      delete window.theme.collection.filterData[filterType];
    } else {
      thisFilterObj.handle = filterHandle;
      thisFilterObj.pretty = filterPretty;

      if (filterType === 'range') {
        if (thisFilterObj.handle !== 'filter-range-clarity' && window.theme.collection.filterData.material.handle === 'filter-material-clear') {
          window.theme.collection.filterData.material = {};
        } else if (thisFilterObj.handle === 'filter-range-clarity' && window.theme.collection.filterData.material.handle !== 'filter-material-clear') {
          window.theme.collection.filterData.material = {};
        }
      }

      if (filterType === 'material') {
        if (thisFilterObj.handle === 'filter-material-clear' && window.theme.collection.filterData.range.handle !== 'filter-range-clarity') {
          window.theme.collection.filterData.range = {
            handle: 'filter-range-clarity',
            pretty: 'Clarity'
          };
        } else if (thisFilterObj.handle !== 'filter-material-clear' && window.theme.collection.filterData.range.handle === 'filter-range-clarity') {
          window.theme.collection.filterData.range = {};
        }
      }
    }
  }

  const filterUrlArray = [];
  Object.keys(window.theme.collection.filterData).forEach(filter => {
    filterHandle = window.theme.collection.filterData[filter].handle;

    if (filterHandle) {
      let filterUrlMap = Array.isArray(filterHandle) ? filterHandle.join('+') : filterHandle;
      filterUrlArray.push(filterUrlMap);
    }
  });
  const filterUrl = filterUrlArray.join('+');
  window.location.href = `${window.theme.collection.filterData.collectionURL}/${filterUrl}${window.location.search}`;
};

const filterLinks = document.querySelectorAll(window.theme.selectors.collection.filterLinks);
filterLinks.forEach(filterLink => {
  filterLink.addEventListener('click', event => {
    event.preventDefault();
    const filterHandle = event.currentTarget.parentNode.dataset.filter;
    const filterPretty = event.currentTarget.parentNode.dataset.filterPretty;
    const filterType = event.currentTarget.parentNode.dataset.filterType;
    filterURLBuilder({
      filterHandle,
      filterPretty,
      filterType
    });
  });
});
filterCancelLinks.forEach(cancelLink => {
  cancelLink.addEventListener('click', event => {
    event.preventDefault();
    const filterData = window.theme.collection.filterData;
    filterData.device = {};
    filterData.range = {};
    filterData.material = {};
    filterURLBuilder({
      clearAll: true
    });
  });
});

const stickyFilter = pageY => {
  const noticeBarHeight = document.querySelector('.notice-bar').offsetHeight;
  const headerMainHeight = document.querySelector('.hdr-main').offsetHeight;
  const stickyFilterHeight = document.querySelector('.filter-sticky').offsetHeight;
  const collectionGridHeight = document.querySelector('.collection-grid').offsetHeight;
  const collectionGridBottom = document.querySelector('.collection-grid').getBoundingClientRect().bottom;
  const freezeHeight = collectionGridHeight - stickyFilterHeight;
  const stickyFilterWidth = document.querySelector('.filter-sticky').offsetWidth;
  const root = document.documentElement;
  root.style.setProperty('--header-height', headerMainHeight + 'px');

  if (collectionGridBottom <= window.innerHeight) {
    filterStickyEl.classList.remove('filter-sticky--active');
    filterStickyEl.style.top = `${freezeHeight}px`;
  } else {
    filterStickyEl.style.top = '';
    filterStickyEl.style.position = '';
    filterStickyEl.style.width = '';

    if (pageY <= headerMainHeight - noticeBarHeight) {
      filterStickyEl.classList.remove('filter-sticky--active');
    } else {
      filterStickyEl.classList.add('filter-sticky--active');
      filterStickyEl.style.width = `${stickyFilterWidth}px`;
    }
  }
};

const stickyFilterMobile = () => {
  const mobileStickyEl = document.querySelector('.filter-mobile-sticky');
  filterStickyEl.classList.remove('filter-sticky--active');
  filterStickyEl.style.removeProperty('width'); // Add class if user has scrolled 50px
  // ** 50px scrolled is when the notice bar is hidden from view **

  if (window.pageYOffset > 50) {
    mobileStickyEl.classList.add('is-fixed');
  } else {
    mobileStickyEl.classList.remove('is-fixed');
  }
};
/**
 * Set sticky sidebar on scroll.
 * Do not make sidebar sticky when there's only 1 row of products.
 */


const determineStickyFilters = () => {
  // Only select grid items that are visible
  const numberOfVisibleProducts = document.querySelectorAll(`${window.theme.selectors.collection.gridItem}:not(.dn)`).length;

  if (window.theme.helpers.bp('min', 960)) {
    if (numberOfVisibleProducts > 2) {
      stickyFilter(window.pageYOffset);
    }
  } else {
    stickyFilterMobile();
  }
};
/**
 * Toggle MagSafe info above filters.
 */


const filterMagsafeContainers = Array.from(document.querySelectorAll('[js-filter="magsafe-container"]'));

if (filterMagsafeContainers.length) {
  filterMagsafeContainers.forEach(container => {
    const filterExpandLink = container.querySelector('[js-filter="expand-link"]');
    const filterExpandedText = container.querySelector('[js-filter="expanded-text"]');
    filterExpandLink.addEventListener('click', () => {
      filterExpandedText.classList.toggle('is-visible');
    });
  });
}

document.addEventListener('scroll', determineStickyFilters, false);
document.addEventListener('resize', determineStickyFilters, false);
/**
 * Builds the inline gallery on the grid by looping through the DOM and gatherin
 * @param {element} gallery gallery element for each gridGallery (see _collection.selectors.js) element
 * @param {number} index index number of the item in the grid
 * @param {Array} flkty array of active galleries initialised
 * @return {function} initializes flikity slider and stores into an array
 */
window.theme.collection.flkty = [];
const gridItem = document.querySelectorAll(window.theme.selectors.collection.gridItem);
let gridItemArray = [];
let gridGalleryArray = [];
gridItem.forEach(item => {
  const gridItemIndex = item.dataset.index;
  gridItemArray[gridItemIndex] = item;
});

const galleryHandler = (gallery, i, startAt = 0) => {
  let options = {
    cellAlign: 'center',
    draggable: false,
    lazyLoad: 1,
    initialIndex: startAt,
    imagesLoaded: true
  };
  window.theme.collection.flkty[i] = new Flickity(gallery, options);
  window.theme.collection.flkty[i].on('imagesLoadedProgress', () => {
    gridItemArray[i].classList.remove('loading'); // gallery.style.height = 'auto'
  });
};
/**
 * loops through the matching selectors in the DOM and passes the DOM element to the gallery handler
 * @return {function} galleryHandler
 */


const gridGallery = document.querySelectorAll(window.theme.selectors.collection.gridGallery);
gridGallery.forEach(gallery => {
  const gridItemIndex = gallery.closest('.grid-item').dataset.index;
  gridGalleryArray[gridItemIndex] = gallery;
  galleryHandler(gridGalleryArray[gridItemIndex], gridItemIndex);
});
/**
 * Update price when dropdown changes.
 */

const priceHandler = currentTarget => {
  const variantId = currentTarget.dataset.variantId;
  const index = currentTarget.dataset.index;
  const price = window.productVariants[variantId].price;
  const priceCompare = window.productVariants[variantId].compare;
  /**
  * Update price when dropdown changes.
  */

  const priceEls = gridItemArray[index].querySelectorAll(window.theme.selectors.collection.price);
  const priceCompareEl = gridItemArray[index].querySelector(window.theme.selectors.collection.priceCompare);

  if (priceCompare && priceCompare !== '' && priceCompare > price) {
    priceCompareEl.classList.remove('dn');
    priceCompareEl.innerHTML = priceCompare;
  } else {
    priceCompareEl.classList.add('dn');
  }

  for (let i = 0; i < priceEls.length; i++) {
    priceEls[i].innerHTML = price;
  }
};
/**
 * Update the offer tags on the product card.
 */


const updateOffers = currentTarget => {
  const offersArray = [];
  const variantId = currentTarget.dataset.variantId;
  const index = currentTarget.dataset.index;
  const {
    comparePence,
    pricePence,
    offers
  } = window.productVariants[variantId];
  offers.forEach(offer => {
    const offer_handle = window.theme.helpers.handleize(offer);
    offersArray.push(`<div class="grid-item-offer grid-item-offer--${offer_handle.includes('magsafe') ? 'light' : 'dark'}">${offer}</div>`);
  }); // Add percentage off tag if product is on sale

  if (Number(comparePence) > Number(pricePence)) {
    const percentOff = Math.round((comparePence - pricePence) * 100 / comparePence);
    offersArray.push(`<div class="grid-item-offer grid-item-offer--dark">-${percentOff}%</div>`);
  }

  gridItemArray[index].querySelector(window.theme.selectors.collection.gridItemOffersContainer).innerHTML = offersArray.join('');
};
/**
 * Update the gallery images on dropdown change.
 */


const updateGalleryImages = currentTarget => {
  // Only run if current product is a gallery. (has multiple product images)
  if (!currentTarget.closest(window.theme.selectors.collection.gridItem).querySelector(window.theme.selectors.collection.gridGallery)) {
    return;
  }

  const variantId = currentTarget.dataset.variantId;
  const index = currentTarget.dataset.index;
  const galImages = [];
  const {
    images,
    url
  } = window.productVariants[variantId];
  let imgAlt = '';

  if (images.length) {
    gridGalleryArray[index].style.height = `${gridGalleryArray[index].offsetHeight}px`;
    gridGalleryArray[index].style.overflow = `hidden`;
    images.forEach(image => {
      // Remove the material/size from the alt tag and trim the whitespace.
      if (image.alt.includes('|')) {
        imgAlt = image.alt.slice(0, image.alt.indexOf('|')).trim();
      } else {
        imgAlt = image.alt;
      }

      let img = `
        <div class="grid-gallery__slide">
          <a href="${url}">
            <img data-flickity-lazyload="${image.main}" alt="${imgAlt}">
          </a>
        </div>
      `;
      galImages.push(img);
    });
    gridItemArray[index].classList.add('loading');
    setTimeout(() => {
      var prevSelectedIndex = window.theme.collection.flkty[index].selectedIndex;
      window.theme.collection.flkty[index].destroy();
      gridGalleryArray[index].innerHTML = galImages.join('');
      galleryHandler(gridGalleryArray[index], index, prevSelectedIndex);

      if (window.matchMedia('(max-width: 959px)').matches) {
        let slider = window.theme.collection.flkty[index];
        slider.options.draggable = true;
        slider.updateDraggable();
      }
    }, 1000);
  }
};

const checkStockLevels = currentTarget => {
  const variantId = currentTarget.dataset.variantId;
  const priceWrapper = currentTarget.closest(window.theme.selectors.collection.gridItemBottom).querySelector(window.theme.selectors.collection.priceWrapper);
  const addToCartBtn = currentTarget.closest('form').querySelector(window.theme.selectors.collection.submitCart);
  const moreDetailsBtn = currentTarget.closest('form').querySelector(window.theme.selectors.collection.moreDetailsBtn);
  const preorderAlert = currentTarget.closest('form').querySelector(window.theme.selectors.collection.preorderAlert);
  const preorderDateHTML = preorderAlert.querySelector(window.theme.selectors.collection.preorderDate);
  const zeroProduct = window.productVariants[variantId].pricePence === '0';
  let addToCartText = '';
  let moreDetailsText = 'More details';
  let addToCartDisabled = false;
  let preorderVariant = false;
  priceWrapper.classList.remove('dn');
  addToCartBtn.removeAttribute('data-preorder');
  preorderAlert.classList.add('dn');

  switch (window.productVariants[variantId].variantState) {
    case 'state_instock':
      addToCartText = 'Add to Cart';
      addToCartDisabled = false;
      break;

    case 'state_preorder':
      addToCartText = 'Pre-order';
      addToCartDisabled = false;
      preorderVariant = true;
      break;

    case 'state_oos':
      addToCartText = 'Out of Stock';
      addToCartDisabled = true;
      break;

    case 'state_discontinued':
      addToCartText = 'Out of Stock';
      addToCartDisabled = true;
      break;

    case 'state_coming_soon':
      addToCartText = 'Coming Soon';
      moreDetailsText = 'Email me<span class="hide--xl-down"> when available</span>';
      addToCartDisabled = true;
      if (zeroProduct) priceWrapper.classList.add('dn');
      break;

    default:
      addToCartText = 'Add to Cart';
      addToCartDisabled = false;
  }

  addToCartBtn.innerText = addToCartText;
  moreDetailsBtn.innerHTML = moreDetailsText;
  addToCartBtn.disabled = addToCartDisabled;

  if (preorderVariant) {
    preorderAlert.classList.remove('dn');
    preorderDateHTML.innerHTML = window.productVariants[variantId].preorderDate;
    addToCartBtn.setAttribute('data-preorder', '');
  }
};

const linkHandler = currentTarget => {
  let variantId = currentTarget.dataset.variantId;
  let productURLwithVariant = window.productVariants[variantId].url;
  gridItemArray[currentTarget.dataset.index].querySelectorAll(window.theme.selectors.collection.productURL).forEach(productLink => {
    productLink.href = productURLwithVariant;
  });
};

const selectOptions = document.querySelectorAll(window.theme.selectors.collection.variantSelector);
selectOptions.forEach(select => {
  select.addEventListener('change', event => {
    const selectedOption = event.target.selectedOptions[0];
    priceHandler(selectedOption);
    updateOffers(selectedOption);
    updateGalleryImages(selectedOption);
    checkStockLevels(selectedOption);
    linkHandler(selectedOption);
  });
});
/**
 * Save collection URL & title to session storage so breadcrumbs
 * can be properly populated on product pages.
 */
const saveCollectionHandle = () => {
  const collectionMetaElement = document.querySelector('[el="collection-meta"]');
  const {
    url,
    title
  } = collectionMetaElement.dataset;
  const data = {
    url,
    title
  };
  sessionStorage.setItem('parentCollection', JSON.stringify(data));
};

document.addEventListener('DOMContentLoaded', () => {
  saveCollectionHandle();
});
// On mobile the device filter needs to dropdown starting from manufacturer down to modile i.e. iPhone -> XS Max
const filterDevices = document.querySelectorAll(window.theme.selectors.collection.filterDevices);
let activeDeviceList;
filterDevices.forEach(filterDevice => {
  filterDevice.addEventListener('click', event => {
    if (filterDevice.getAttribute('href') === '#') {
      event.preventDefault();
    }

    if (window.matchMedia('(max-width: 959px)').matches) {
      event.preventDefault();
      const selectedDevice = event.currentTarget.parentNode.dataset.filter;
      document.querySelector('.filter-list--device').classList.remove(activeDeviceList);
      document.querySelector('.filter-list--device').classList.add(selectedDevice, 'filter-list--device-active');
      activeDeviceList = selectedDevice;
      const selectedDeviceElement = document.querySelector(`#${selectedDevice}`);
      window.theme.collection.filterFlick = new Flickity(selectedDeviceElement, {
        contain: '80%'
      });
    }
  });
});
const mobileFilterSlider = window.theme.helpers.debounceEvent(() => {
  if (window.outerWidth >= 960 && window.theme.collection.filterFlick) {
    window.theme.collection.filterFlick.destroy();
    delete window.theme.collection.filterFlick;
    document.querySelector('.filter-list--device').classList.remove(activeDeviceList, 'filter-list--device-active');
  }
}, 250);
window.addEventListener('resize', mobileFilterSlider);
document.addEventListener('DOMContentLoaded', function () {
  mobileFilterSlider();
  const deviceFilter = document.querySelector('a[href="#filter-list--device"]');

  if (!deviceFilter.classList.contains('filter-mobile__dropdown-btn--selected')) {
    deviceFilter.click();
  }
}); // Dropdown toggler for mobile filter

const mobileFilterDropdowns = document.querySelectorAll(window.theme.selectors.collection.mobileFilterDropdowns);
mobileFilterDropdowns.forEach(dropdown => {
  dropdown.addEventListener('click', event => {
    event.preventDefault();
    const classNames = {
      dropdownHasSelectedFilter: 'filter-mobile__dropdown-btn--selected',
      dropdownActive: 'filter-mobile__dropdown-btn--active',
      filterListActive: 'filter-list--active'
    };
    const thisDropdown = event.currentTarget.closest('.filter-mobile__dropdown-btn');
    document.querySelector('.filter-list--device').classList.remove(activeDeviceList, 'filter-list--device-active');

    if (!thisDropdown.classList.contains(classNames.dropdownHasSelectedFilter)) {
      if (thisDropdown.classList.contains(classNames.dropdownActive)) {
        thisDropdown.classList.toggle(classNames.dropdownActive);
        const dropdownToClose = thisDropdown.hash.replace('#', '.');
        document.querySelector(dropdownToClose).classList.remove(classNames.filterListActive);
      } else {
        if (document.querySelector(`.${classNames.dropdownActive}`)) {
          document.querySelector(`.${classNames.dropdownActive}`).classList.remove(classNames.dropdownActive);
        }

        thisDropdown.classList.add(classNames.dropdownActive);

        if (document.querySelector(`.${classNames.filterListActive}`)) {
          document.querySelector(`.${classNames.filterListActive}`).classList.remove(classNames.filterListActive);
        }

        const dropdownToOpen = thisDropdown.hash.replace('#', '.');
        document.querySelector(dropdownToOpen).classList.add(classNames.filterListActive);
      }
    }
  });
}); // Cancel selected filter on mobile from the dropdown button close icon

const mobileFilterDropdownsCancel = cancelTarget => {
  cancelTarget.addEventListener('click', event => {
    event.preventDefault();

    if (event.currentTarget.classList.contains('filter-mobile__dropdown-btn--selected')) {
      const filterHandle = cancelTarget.dataset.filter;
      const filterType = cancelTarget.dataset.filterType;
      const filterPretty = cancelTarget.dataset.filterPretty;
      filterURLBuilder({
        filterHandle,
        filterPretty,
        filterType
      });
    }
  });
}; // Mobile on load replace default Dropdown names with selected filters and show cancel icon


const mobileFilterDropdownsShowActive = () => {
  const filterData = window.theme.collection.filterData;

  for (let prop in filterData) {
    if (filterData[prop].hasOwnProperty('pretty') && filterData[prop].pretty !== '') {
      if (prop === 'device') {
        const dropdownDevice = document.querySelector('a[href="#filter-list--device"]');
        dropdownDevice.querySelector('span').textContent = filterData.device.pretty;
        dropdownDevice.classList.add('filter-mobile__dropdown-btn--selected');
        dropdownDevice.dataset.filterType = 'device';
        dropdownDevice.dataset.filter = filterData.device.handle;
        dropdownDevice.dataset.filterPretty = filterData.device.pretty;
        mobileFilterDropdownsCancel(dropdownDevice);
      } else if (prop === 'range') {
        const dropdownRange = document.querySelector('a[href="#filter-list--range"]');
        dropdownRange.querySelector('span').textContent = filterData.range.pretty;
        dropdownRange.classList.add('filter-mobile__dropdown-btn--selected');
        dropdownRange.dataset.filterType = 'range';
        dropdownRange.dataset.filter = filterData.range.handle;
        dropdownRange.dataset.filterPretty = filterData.range.pretty;
        mobileFilterDropdownsCancel(dropdownRange);
      }
    }
  }
};

mobileFilterDropdownsShowActive();
window.theme.selectors.addToCart = {
  submitCart: '.cart-submit',
  alert: '.alert',
  variantSelector: '.variant-selector',
  variantSelect: '.js-variant-select'
};
const elAddToCartAlert = document.querySelector(window.theme.selectors.addToCart.alert);
const elSubmitTriggers = document.querySelectorAll(window.theme.selectors.addToCart.submitCart); // Global cart feedback

const cartFeedback = () => {
  elAddToCartAlert.classList.add('alert--open', 'alert--success');
  elAddToCartAlert.innerHTML = `Item added to cart`;
  window.Shopify.cartCount();
  setTimeout(() => {
    window.Shopify.toggleCart();
  }, 400);
  window.Shopify.buildCartData();
  setTimeout(() => {
    window.Shopify.checkClarityInBasket();
  }, 1000); // elCartModal main.js

  elCartModal.classList.add('hdr-cart__modal--atc');
  setTimeout(() => {
    elAddToCartAlert.classList.remove('alert--open', 'alert--success');
  }, 2000);
}; // Ajax Cart


window.Shopify.queue = [];

window.Shopify.addItem = (id, quantity, properties = {}, callback) => {
  const item = {
    quantity,
    id,
    properties
  };
  window.theme.helpers.callToAPI('/cart/add.js', 'POST', item).then(() => callback());
};

window.Shopify.moveAlong = () => {
  if (window.Shopify.queue.length > 0) {
    const request = window.Shopify.queue.shift();
    window.Shopify.addItem(request.variantId, request.quantity, request.properties, window.Shopify.moveAlong);
  } else {
    window.Shopify.queue = [];
    cartFeedback();
  }
};

elSubmitTriggers.forEach(button => {
  button.addEventListener('click', e => {
    e.preventDefault(); // Add no events class to button to stop multiple clicks

    button.classList.add('btn--no-events');
    let form;
    let properties = {};

    if (window.theme.helpers.isQuickview) {
      form = button.closest('form');
    } else {
      form = document.querySelector('form[action="/cart/add"]');
    }

    if (button.hasAttribute('data-preorder')) {
      properties = {
        _preorder: true
      };
    }

    buildCart(form, properties);
    window.Shopify.moveAlong();
  });
});

const buildCart = (form, properties) => {
  const variantSelector = form.querySelector(window.theme.selectors.addToCart.variantSelector);
  let dataLayerData;
  let selectedVariant;

  if (variantSelector) {
    if (variantSelector.nodeName === 'SELECT') {
      dataLayerData = window.productVariants[variantSelector.value];
      selectedVariant = variantSelector.options[variantSelector.selectedIndex];
    } else {
      form.querySelectorAll(window.theme.selectors.addToCart.variantSelector).forEach(variant => {
        if (variant.checked === true || variant.classList.contains('single-option') || variant.classList.contains('select')) {
          dataLayerData = window.productVariants[variant.dataset.variantId];
          selectedVariant = variant;
        }
      });
    } // Add initially clicked product to cart


    window.Shopify.queue.push({
      variantId: selectedVariant.dataset.variantId,
      quantity: 1,
      properties
    }); // Free TPU with certain cases

    if (window.theme.caseSkusTPU[selectedVariant.dataset.sku]) {
      properties['_bundledVariantId'] = window.theme.caseSkusTPU[selectedVariant.dataset.sku];
      window.Shopify.queue.push({
        variantId: window.theme.caseSkusTPU[selectedVariant.dataset.sku],
        quantity: 1
      });
    }
    /**
     * Wireless charger with stand bundle.
     * - Check to see if handle array includes the product handle then if it does,
     * check for an exact match as some products will have similar handles.
     */


    if (window.theme.wirelessChargerBundle.handles.includes(selectedVariant.dataset.productHandle)) {
      window.theme.wirelessChargerBundle.handles.forEach(handle => {
        if (handle === selectedVariant.dataset.productHandle) {
          properties['_bundledVariantId'] = window.theme.wirelessChargerBundle.standId;
          window.Shopify.queue.push({
            variantId: window.theme.wirelessChargerBundle.standId,
            quantity: 1,
            properties: {
              _isHiddenBundledItem: true
            }
          });
        }
      });
    }

    dataLayerAddCart(dataLayerData);
  }
};
/**
 * Add to cart dataLayer event on selected variant.
 */


const dataLayerAddCart = ({
  dataLayer
}) => {
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    event: 'addToCart',
    ecommerce: {
      currencyCode: window.theme.shopCurrencyISO,
      add: {
        products: [dataLayer]
      }
    }
  });
};