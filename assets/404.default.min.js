const template404 = document.querySelector('.template-404');
/**
 * Redirect users if they are trying to access an old page
 */

const urlRedir = async () => {
  const url = window.location.href; // Target product pages

  let regex = /collections\/+[.\S]+\/products/g;
  let repString = 'products'; // Test the old product pages before checking the redir object

  if (regex.test(url)) {
    let newUrl = url.replace(regex, repString);
    window.location.href = newUrl;
  } else {
    const fetchUrl = 'https://mous-apps.herokuapp.com/api/404redirects';
    const currentUrl = window.location.pathname;
    const postData = {
      url: currentUrl
    };
    await fetch(fetchUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      referrerPolicy: 'no-referrer',
      body: JSON.stringify(postData)
    }).then(response => response.json()).then(data => {
      if (data.redirectError) {
        throw Error(data.redirectError);
      }

      if (data.redirectTo) {
        window.location.href = data.redirectTo;
      } else {
        template404.classList.add('is-ready');
      }
    }).catch(error => {
      console.error(error);
      template404.classList.add('is-ready');
    });
  }
};

window.addEventListener('DOMContentLoaded', () => {
  urlRedir();
});