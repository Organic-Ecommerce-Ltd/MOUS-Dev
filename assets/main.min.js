// ------------------------------------------------------------
// Selectors - all in one place so we don't have to hunt
// ------------------------------------------------------------
window.theme.selectors.main = {
  header: '[el="header"]',
  noticeBanner: '[header="notice-bar"]',
  caseLink: 'a[href="/collections/phone-cases"]',
  modalLink: '[popup="trigger"]',
  modalBg: '.modal-bg',
  modalClose: '.modal-close',
  videoLink: '[modal-trigger="youtube"]',
  qtyInput: '.js-qty-input',
  acceptCookiesBtn: '[el="cookie-acceptance"]'
}; // Nodes

const elHeader = document.querySelector(window.theme.selectors.main.header);
const noticeBanner = elHeader.querySelector(window.theme.selectors.main.noticeBanner);
const elHTML = document.querySelector('html');
const elBodyOnly = document.querySelector('body');
const elVideo = document.querySelector('.video-content');
const elModalLink = document.querySelectorAll(window.theme.selectors.main.modalLink);
const elVideoLink = document.querySelectorAll(window.theme.selectors.main.videoLink);
const elModalCloseSelectors = document.querySelectorAll([window.theme.selectors.main.modalClose, window.theme.selectors.main.modalBg]);
const acceptCookiesBtn = document.querySelector(window.theme.selectors.main.acceptCookiesBtn); // Globals

const cookiesName = 'cookies_accepted';
const flktyMain = {};
let pageYOffsetPreviousPosition = window.pageYOffset; // ------------------------------------------------------------
// Helpers writtern in ES6
// ------------------------------------------------------------

window.theme.helpers.debounceEvent = (callback, time) => {
  let interval;
  return (...args) => {
    clearTimeout(interval);
    interval = setTimeout(() => {
      interval = null;
      callback(...args);
    }, time);
  };
};

window.theme.helpers.callToAPI = (url = ``, method = 'GET', data = {}) => {
  return new Promise(function (resolve, reject) {
    let xhr = new XMLHttpRequest();
    xhr.open(method, url);

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve(JSON.parse(xhr.response));
      } else {
        reject(xhr.statusText);
      }
    };

    if (method === 'GET') {
      xhr.send();
    } else {
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify(data));
    }

    xhr.onerror = () => reject(xhr.statusText);
  });
};

window.theme.helpers.handleize = str => {
  str = str.toLowerCase();
  var toReplace = ['"', '\'', '\\', '(', ')', '[', ']'];

  for (var i = 0; i < toReplace.length; ++i) {
    str = str.replace(toReplace[i], '');
  }

  str = str.replace(/\W+/g, '-');

  if (str.charAt(str.length - 1) === '-') {
    str = str.replace(/-+z/, '');
  }

  if (str.charAt(0) === '-') {
    str = str.replace(/A-+/, '');
  }

  return str;
};

window.theme.helpers.camelize = str => {
  return str.replace(/(?:^\w|[A-Z]|\b\w)/g, (word, index) => {
    return index === 0 ? word.toLowerCase() : word.toUpperCase();
  }).replace(/\s+/g, '');
};

window.theme.helpers.capitalize = str => {
  if (typeof str !== 'string') return '';
  return str.charAt(0).toUpperCase() + str.slice(1);
};

window.theme.helpers.bp = (minmax, size) => {
  return window.matchMedia(`(${minmax}-width: ${size}px)`).matches;
};

window.theme.helpers.addParamToUrl = param => {
  let _url = window.location.href;

  if (_url.includes(param)) {
    return;
  }

  _url += (_url.split('?')[1] ? '&' : '?') + param;
  return _url;
}; // ------------------------------------------------------------
// Scrolling Functions
// ------------------------------------------------------------


window.theme.hdrScroll = () => {
  const mobileCollectionFilter = document.querySelector('.filter-mobile-sticky');

  if (window.scrollY >= 50) {
    elHeader.classList.add('hdr--small');

    if (pageYOffsetPreviousPosition > window.pageYOffset && elHeader.classList.contains('hdr--small')) {
      elHeader.classList.add('hdr-reveal');

      if (mobileCollectionFilter && window.matchMedia('(max-width: 959px)').matches) {
        elBodyOnly.classList.add('hdr-reveal');
      }
    } else {
      elHeader.classList.remove('hdr-reveal');

      if (mobileCollectionFilter && window.matchMedia('(max-width: 959px)').matches) {
        elBodyOnly.classList.remove('hdr-reveal');
      }
    }
  } else {
    elHeader.classList.remove('hdr--small');
  }

  pageYOffsetPreviousPosition = window.pageYOffset;
};

window.theme.scrolledPast = (el, offset = 250) => {
  const elementHeight = el.offsetHeight + offset;
  const pageY = window.pageYOffset;
  return elementHeight > pageY;
}; // ------------------------------------------------------------
// Modal Functions
// ------------------------------------------------------------


window.theme.bodyFixed = arg => {
  if (arg === 'unlock') {
    elHTML.classList.remove('is-fixed');

    document.ontouchmove = () => {
      return true;
    };
  } else if (arg === 'toggle') {
    elHTML.classList.toggle('is-fixed');
  } else {
    elHTML.classList.add('is-fixed');

    document.ontouchmove = event => {
      event.preventDefault();
    };
  }
};

window.theme.modalOpen = modal => {
  modal.classList.add('show');
  /**
   * Prevent email signup popup from showing if modal has attribute
   */

  if (modal.hasAttribute('device-picker') && window.history.pushState) {
    const newURL = window.theme.helpers.addParamToUrl('device-picker');
    window.history.replaceState({
      path: newURL
    }, '', newURL);
  }

  window.theme.bodyFixed();
};

window.theme.modalClose = el => {
  const modal = el.closest('.modal');

  if (modal.id === 'video-full') {
    closeVideo();
  }

  modal.classList.remove('show');
  window.theme.bodyFixed('unlock');
}; // ------------------------------------------------------------
// Video Modal
// ------------------------------------------------------------
// Functions for opening & closing the video modal


const openVideo = video => {
  var queryString = video.split('?v=')[1];
  var iFrameCode = `<iframe scrolling="no" allowtransparency="true" allowfullscreen="true" src="https://www.youtube.com/embed/${queryString}?rel=0&wmode=transparent&showinfo=0&autoplay=1" frameborder="0"></iframe>`;
  elVideo.innerHTML = iFrameCode;
  elVideo.closest('.modal').classList.add('show');
  window.theme.bodyFixed();
};

const closeVideo = () => {
  elVideo.innerHTML = '';
  elVideo.closest('.modal').classList.remove('show');
}; // ------------------------------------------------------------
// Cart/MiniCart Functions
// ------------------------------------------------------------


const qtyChange = el => {
  const quantityChange = new CustomEvent('quantityChange');
  const adjust = parseInt(el.dataset.delta);
  const input = el.parentNode.querySelector(window.theme.selectors.main.qtyInput);
  const currentVal = parseInt(input.value);
  let newVal = currentVal + adjust;

  if (newVal < 0) {
    newVal = 1;
  }

  input.value = newVal;
  input.dataset.delta = adjust;
  input.dispatchEvent(quantityChange);
}; // ------------------------------------------------------------
// Cookies Banner Events
// ------------------------------------------------------------


const getCookie = name => {
  var pair = document.cookie.match(new RegExp(name + '=([^]+)'));
  return !!pair ? pair[1] : null; // eslint-disable-line
};

const checkCookies = () => {
  if (!getCookie(cookiesName)) {
    const cookiesMessage = document.getElementById("cb-message");
    cookiesMessage.classList.add('open');
    elBodyOnly.classList.add('cb-banner-open');
  }
};

const closeCookiesBanner = () => {
  window.theme.helpers.setCookie(cookiesName, true, 9999);
  document.getElementById('cookies-banner-container').removeChild(document.getElementById('cb-message'));
  elBodyOnly.classList.remove('cb-banner-open');
}; // ------------------------------------------------------------
// Geolocation based content
// ------------------------------------------------------------

/**
 * Return some html based on the geo-location of the user.
 */


const locationBasedMarkup = (location, object) => {
  let str;
  Object.entries(object).forEach(arr => {
    if (arr[0] === location) {
      str = arr[1];
    }
  });
  return str;
};
/**
 * Location Based Text Update
 * - updates header notice bar text
 * - updates shipping notice text
 *
 * @param {string} location users location
 * @param {HTMLElement} elem element to update text
 * @param {(string|object)} content - string of text to update or and object with location and the string related to that location
 */


const locationBasedTextUpdate = (location, elem, content) => {
  const elemText = typeof content === 'string' ? content : locationBasedMarkup(location, content);
  elem.textContent = elemText;
  elem.classList.add('is-ready');
}; // Product returns text - (only on old product page template)


const returnsPolicyHTML = (location, elem) => {
  let returnsHTML = locationBasedMarkup(location, {
    US: window.theme.strings.returnsPolicy.rowUS,
    CA: window.theme.strings.returnsPolicy.rowCA,
    AU: window.theme.strings.returnsPolicy.rowAU,
    DE: window.theme.strings.returnsPolicy.euDE,
    NL: window.theme.strings.returnsPolicy.euNL
  });

  if (returnsHTML.includes('|')) {
    returnsHTML = returnsHTML.split('|');
    returnsHTML = `<h5 class="title">${returnsHTML[0]}</h5>
                   <p class="subtitle">${returnsHTML[1]}</p>`;
  } else {
    returnsHTML = `<h5 class="title">${returnsHTML}</h5>`;
  }

  elem.innerHTML = returnsHTML;
  elem.classList.add('is-ready');
};

const usrLocationSet = () => {
  const location = window.theme.helpers.findCookie('usrLocation');
  const locationState = window.theme.helpers.findCookie('usrLocationState');

  if (location) {
    const locationArr = ['US', 'CA', 'AU', 'DE', 'NL'];
    const excludedUsStates = ['AK', 'HI'];
    const noticeBarEl = document.querySelector('[header="dynamic-shipping-text"]');
    const noticeBarExcludedStateEl = document.querySelector('[header="excluded-state"]');
    const returnsWrapper = document.querySelector('[el="returns-wrapper"]');
    const shippingNotice = document.querySelector('[pos="shipping-notice"]');

    if (locationArr.includes(location)) {
      locationBasedTextUpdate(location, noticeBarEl, {
        US: window.theme.strings.noticeBar.rowUS,
        CA: window.theme.strings.noticeBar.rowCA,
        AU: window.theme.strings.noticeBar.rowAU,
        DE: window.theme.strings.noticeBar.euDE,
        NL: window.theme.strings.noticeBar.euNL
      });

      if (window.location.href.includes('/products/')) {
        returnsWrapper && returnsPolicyHTML(location, returnsWrapper);

        if (document.body.contains(shippingNotice)) {
          shippingNotice && locationBasedTextUpdate(location, shippingNotice, {
            US: window.theme.strings.returnsPolicy.rowUS,
            CA: window.theme.strings.returnsPolicy.rowCA,
            AU: window.theme.strings.returnsPolicy.rowAU,
            DE: window.theme.strings.returnsPolicy.euDE,
            NL: window.theme.strings.returnsPolicy.euNL
          });
        }
      }
    } else {
      noticeBarEl && noticeBarEl.classList.add('is-ready');
      returnsWrapper && returnsWrapper.classList.add('is-ready');
      shippingNotice && shippingNotice.classList.add('is-ready');
    }

    if (noticeBarExcludedStateEl) {
      if (excludedUsStates.includes(locationState)) {
        noticeBarExcludedStateEl.classList.add('is-ready');
      } else {
        noticeBarExcludedStateEl.parentElement.remove();
      }
    }
  } else {
    setTimeout(usrLocationSet, 100);
  }
};
/**
 * New navigation logic.
 */


const setupMainNavigation = () => {
  const classes = {
    active: 'is-active',
    fixed: 'is-fixed'
  };
  const selectors = {
    html: 'html',
    header: '[el="header"]',
    hamburgerBtn: '[header="hamburger"]',
    navWrapper: '[nav="wrapper"]',
    listItem: '[nav-item]',
    parentListItem: '[nav-item="l1"]',
    childListItem: '[nav-item="l2"]',
    submenu: '[nav-submenu]',
    submenuTopLevel: '[nav-submenu="parent"]',
    submenuTrigger: '[nav="submenu-trigger"]',
    parentMenuTrigger: '[nav="parent-menu-trigger"]',
    combinedLists: '[nav="combined-lists"]'
  };
  const nodes = {
    html: document.querySelector(selectors.html),
    header: document.querySelector(selectors.header),
    hamburgerBtn: document.querySelector(selectors.hamburgerBtn),
    navWrapper: document.querySelector(selectors.navWrapper),
    listItem: Array.from(document.querySelectorAll(selectors.listItem)),
    parentListItem: Array.from(document.querySelectorAll(selectors.parentListItem)),
    childListItem: Array.from(document.querySelectorAll(selectors.childListItem)),
    submenu: Array.from(document.querySelectorAll(selectors.submenu)),
    submenuTopLevel: Array.from(document.querySelectorAll(selectors.submenuTopLevel)),
    submenuTrigger: Array.from(document.querySelectorAll(selectors.submenuTrigger)),
    parentMenuTrigger: Array.from(document.querySelectorAll(selectors.parentMenuTrigger))
  };
  const globals = {
    closeTimer: null
  };
  /**
   * Close mobile menu when clicking outside of it and only if main nav is active.
   */

  document.addEventListener('click', event => {
    if (!event.target.closest(selectors.navWrapper) && !event.target.matches(selectors.hamburgerBtn) && nodes.navWrapper.classList.contains(classes.active)) {
      resetNavigation();
    }
  });
  /**
   * On resize, reset menu.
   */

  window.addEventListener('resize', window.theme.helpers.debounceEvent(() => {
    resetNavigation();
  }, 250));
  /**
   * Click handlers
   */

  nodes.hamburgerBtn.addEventListener('click', event => {
    event.preventDefault();
    toggleMobileMenu(event.currentTarget);
  });
  nodes.submenuTrigger.forEach(link => {
    link.addEventListener('click', event => {
      event.preventDefault();
      toggleSubmenu(event.currentTarget);
    });
  });
  nodes.parentMenuTrigger.forEach(link => {
    link.addEventListener('click', event => {
      event.preventDefault();
      openParentMenu(event);
    });
  });
  /**
   * Timed close of menu on desktop.
   */

  if (window.theme.helpers.bp('min', 960)) {
    nodes.submenuTopLevel.forEach(submenu => {
      submenu.addEventListener('mouseleave', event => {
        // Really annoying when developing
        if (window.theme.helpers.detectStore !== 'DEV') {
          timedCloseSubmenu(event);
        }
      });
      submenu.addEventListener('mouseover', () => {
        clearTimeout(globals.closeTimer);
      });
    });
  }
  /**
   * Remove all active classes and reset css variables to put menu back to default state.
   * - If desktop size, set active class on first child submenu.
   */


  const resetNavigation = () => {
    nodes.html.classList.remove(classes.fixed);
    nodes.hamburgerBtn.classList.remove(classes.active);
    nodes.navWrapper.classList.remove(classes.active);
    document.documentElement.style.setProperty('--submenu-min-height', 0);
    nodes.listItem.forEach(item => {
      item.classList.remove(classes.active);
    });

    if (window.theme.helpers.bp('min', 960)) {
      document.querySelector(selectors.childListItem).classList.add(classes.active);
    }
  };
  /**
   * Toggle mobile menu on hamburger icon.
   */


  const toggleMobileMenu = hamburger => {
    const headerHeight = nodes.header.offsetHeight;
    hamburger.classList.toggle(classes.active);
    nodes.listItem.forEach(item => {
      item.classList.remove(classes.active);
    });
    nodes.html.classList.toggle(classes.fixed);
    document.documentElement.style.setProperty('--header-height', `${headerHeight}px`);
    nodes.navWrapper.classList.toggle(classes.active);
  };
  /**
   * Toggle submenus for multi-level navigation.
   */


  const toggleSubmenu = currentTarget => {
    const currentItem = currentTarget.parentNode;
    const wasDropdownOpen = currentItem.classList.contains(classes.active);
    let topLevelSubmenu = false;

    if (currentItem.getAttribute('nav-item') === 'l1') {
      topLevelSubmenu = true;
      nodes.parentListItem.forEach(item => {
        item.classList.remove(classes.active);
      });

      if (!wasDropdownOpen) {
        currentItem.classList.add(classes.active);
      } // this may not work in the future if we have multiple items with dropdowns.


      if (window.theme.helpers.bp('min', 960)) {
        currentTarget.closest(selectors.navWrapper).classList.toggle(classes.active);
      }
    } else {
      const activeTopLevelSubmenu = currentTarget.closest(selectors.submenuTopLevel);
      const activeSubmenuItems = Array.from(activeTopLevelSubmenu.querySelectorAll(selectors.listItem));
      activeSubmenuItems.forEach(item => {
        item.classList.remove(classes.active);
      });
    }

    setTimeout(() => {
      const combinedListsHeight = currentItem.querySelector(selectors.combinedLists).offsetHeight;
      document.documentElement.style.setProperty('--submenu-min-height', `${combinedListsHeight}px`);
    });

    if (!wasDropdownOpen && topLevelSubmenu || !topLevelSubmenu) {
      currentItem.classList.add(classes.active);
    }
  };
  /**
   * Close dropdown menu when mouse leaves for 1s.
   */


  const timedCloseSubmenu = event => {
    globals.closeTimer = setTimeout(() => {
      event.target.parentNode.classList.remove(classes.active);
    }, 1000);
  };
  /**
   * Go back up a level on the mobile menu.
   */


  const openParentMenu = event => {
    event.target.closest(selectors.listItem).classList.remove(classes.active);
  };
}; // ------------------------------------------------------------
// On Scroll
// ------------------------------------------------------------


window.addEventListener('scroll', () => {
  window.theme.hdrScroll();
}); // ------------------------------------------------------------
// On Document Ready
// ------------------------------------------------------------

document.addEventListener('DOMContentLoaded', () => {
  // Setup header logic
  elHeader.classList.add('loaded');
  window.theme.hdrScroll(); // Cookies acceptance logic

  checkCookies();
  acceptCookiesBtn.addEventListener('click', () => {
    closeCookiesBanner();
  }); // Add loaded class so we can do things

  elBodyOnly.classList.add('loaded'); // Modal Triggers

  elModalLink.forEach(el => {
    el.addEventListener('click', event => {
      event.preventDefault();
      const id = el.dataset.popup;
      const modal = document.querySelector(id);
      window.theme.modalOpen(modal);
    });
  }); // Video Modal

  if (elVideoLink) {
    elVideoLink.forEach(el => {
      el.addEventListener('click', event => {
        event.preventDefault();
        openVideo(el.dataset.video);
      });
    });
  }

  document.addEventListener('click', event => {
    if (event.target.classList.contains('js-qty')) {
      qtyChange(event.target);
    }
  });
  elModalCloseSelectors.forEach(el => {
    el.addEventListener('click', event => {
      window.theme.modalClose(event.target);
    });
  }); // geo location based content

  usrLocationSet(); // create flickity for top banner text

  flktyMain.noticeCarousel = new Flickity(noticeBanner, {
    autoPlay: 5000,
    pageDots: false,
    prevNextButtons: false,
    wrapAround: true
  }); // new nav (03/21)

  setupMainNavigation();
}); // concatinated to main.js

window.theme.selectors.minicart = {
  cartModal: '.hdr-cart__modal',
  cartBg: '.hdr-cart__bg',
  cartList: '.hdr-cart__list',
  cartToggle: '[href="/cart"]',
  cartQtyInput: '.hdr-cart__js-qty',
  cartCount: '#cart-count',
  cartRow: '.hdr-cart__row',
  cartSubtotal: '#cartSubtotal',
  contiueShopping: 'a[href="#continueShopping"]',
  clarityCompatibilityWarning: '.product-info__compatibility-warning'
};
const elCartModal = document.querySelector(window.theme.selectors.minicart.cartModal);
const elCartBg = document.querySelector(window.theme.selectors.minicart.cartBg);
const elCartCount = document.querySelector(window.theme.selectors.minicart.cartCount);
const elSubTotal = document.querySelector(window.theme.selectors.minicart.cartSubtotal);
const elCartToggle = document.querySelector(window.theme.selectors.minicart.cartToggle);
const elContinueShopping = document.querySelector(window.theme.selectors.minicart.contiueShopping);
const elCartList = document.querySelector(window.theme.selectors.minicart.cartList);
const elCartRows = document.querySelectorAll(window.theme.selectors.minicart.cartRow);

window.Shopify.toggleCart = options => {
  if (options === 'hide') {
    elCartModal.classList.add('dn');
    elCartModal.classList.remove('show');
    elHeader.classList.remove('hdr--white');
    elCartBg.classList.add('dn');
  } else {
    elCartModal.classList.toggle('dn');
    elCartModal.classList.toggle('show');
    elHeader.classList.toggle('hdr--white');
    elCartBg.classList.toggle('dn');
  }
};

window.Shopify.buildCartData = () => {
  window.theme.helpers.callToAPI('/cart.js').then(data => {
    window.Shopify.cartData = data;
    window.Shopify.buildCartList();
  }).catch(error => {
    console.error(error);
  });
};

window.Shopify.sendCartQty = (updateData, dataLayer) => {
  const {
    type,
    data
  } = dataLayer;
  window.theme.helpers.callToAPI('/cart/update.js', 'POST', updateData).then(() => {
    window.Shopify.buildCartData();
    minicartDataLayerCartChange(type, data);
    setTimeout(() => {
      window.Shopify.checkClarityInBasket();
    }, 1000);
  }).catch(error => {
    console.error(error);
  });
};

window.Shopify.cartCount = () => {
  let cartCount = 0;
  window.Shopify.cartData.items.forEach(item => {
    if (!item.properties['_isHiddenBundledItem']) {
      cartCount += item.quantity;
    }
  });
  elCartCount.innerHTML = cartCount;

  if (cartCount > 0) {
    elCartCount.classList.add('show');
  } else {
    elCartCount.classList.remove('show');
    window.Shopify.toggleCart('hide');
  }
};

window.Shopify.cartSubtotal = () => {
  elSubTotal.innerHTML = `<span class=money>${window.theme.helpers.formatMoney(window.Shopify.cartData.total_price, window.theme.shopCurrency)}</span>`;
};

window.Shopify.cartListRemove = variantId => {
  elCartRows.forEach(row => {
    if (row.dataset.id === variantId) {
      row.remove();
    }
  });
};

window.Shopify.cartQtyInput = () => {
  const elCartQtyInput = document.querySelectorAll(window.theme.selectors.minicart.cartQtyInput);

  const lineItemSuppress = (lineItem, disable) => {
    lineItem = lineItem.closest('.hdr-cart__row');

    if (disable === true) {
      lineItem.classList.add('disable-line-item');
      lineItem.insertAdjacentHTML('afterbegin', '<div class="blocker"></div>');
    } else if (disable === false) {
      lineItem.classList.remove('disable-line-item');
      lineItem.querySelector('.blocker').remove();
    }
  };

  elCartQtyInput.forEach(qtySelector => {
    const qtySelectorVal = qtySelector.value;
    qtySelector.addEventListener('quantityChange', event => {
      const quantityValue = Number(event.target.value);
      const updateData = {};
      const bundledItemId = event.target.dataset.bundledItem;
      const dataLayer = {
        type: event.target.dataset.delta > 0 ? 'addToCart' : 'removeFromCart'
      };
      lineItemSuppress(qtySelector, true);
      updateData.updates = {
        [event.target.dataset.id]: quantityValue
      };
      window.Shopify.cartData.items.forEach(item => {
        if (item.variant_id == event.target.dataset.id) {
          dataLayer.data = {
            id: item.sku,
            name: item.title,
            brand: item.vendor,
            category: item.product_type,
            variant: item.variant_title,
            price: item.price / 100,
            quantity: 1
          };
        }

        if (bundledItemId) {
          let bundleItemCount = quantityValue;

          if (item.id === bundledItemId) {
            if (qtySelectorVal > quantityValue) {
              bundleItemCount = item.quantity - 1;
            } else {
              bundleItemCount = item.quantity + 1;
            }
          }

          updateData.updates[bundledItemId] = bundleItemCount;
        }
      });
      window.Shopify.sendCartQty(updateData, dataLayer);

      if (event.target.value === 0) {
        window.Shopify.cartListRemove([event.target.dataset.id]);
      }

      if (isIE11) {
        window.location.reload();
      }
    });
  });
};

window.Shopify.buildCartList = () => {
  elCartList.innerHTML = '';
  window.Shopify.cartData.items.forEach(item => {
    let quantityInput = `
      <div class="cart-item-qty">
        <i class="js-qty js-qty-minus" data-delta="-1">-</i>
        <input
          class="hdr-cart__js-qty js-qty-input no-border"
          min="0"
          name="quantity"
          pattern="[0-9]*"
          type="number"
          value="${item.quantity}"
          data-id="${item.variant_id}"
          data-sku="${item.sku}"
          data-bundled-item="${item.properties['_bundledVariantId'] || ''}"
          readonly
        >
        <i class="js-qty js-qty-plus${item.variant_id === Number(window.theme.macsy.variantId) ? ' js-qty--disabled" tabindex="-1' : ''}" data-delta="1">+</i>
      </div>
    `;
    let quantityTextOnly = `
      <div class="cart-item-qty cart-item-qty--text-only">
        Quantity: ${item.quantity}
      </div>
    `;
    let lineItem = `
      <div class="flex items-start hdr-cart__row pt2${item.properties['_isHiddenBundledItem'] ? ' is-hidden' : ''}" data-id="${item.variant_id}">
        <div class="hdr-cart__column flex w-20 w-30-l ph2">
          <a href="${item.product_type !== 'Hidden' ? item.url : '#'}">
            <img src="${item.image}" alt="${item.title} thumbnail">
          </a>
        </div>

        <div class="hdr-cart__column flex w-80 w-70-l tl ph2">
          <h4><a href="${item.product_type !== 'Hidden' ? item.url : '#'}">${item.title}</a></h4>
          <p class="hdr-cart__price">${item.properties && item.properties._finalPrice ? `<s><span class=money>${window.theme.helpers.formatMoney(item.price, window.theme.shopCurrency)}</span></s><span class=money>${window.theme.helpers.formatMoney(item.properties._finalPrice, window.theme.shopCurrency)}</span>` : `<span class=money>${window.theme.helpers.formatMoney(item.price, window.theme.shopCurrency)}</span>`}</p>
          ${item.product_type !== 'Hidden' ? quantityInput : quantityTextOnly}
        </div>
      </div>
    `;
    elCartList.insertAdjacentHTML('beforeend', lineItem);
  });
  window.Shopify.cartQtyInput();
  window.Shopify.cartCount();
  window.Shopify.cartSubtotal();
};

document.addEventListener('DOMContentLoaded', () => {
  window.Shopify.buildCartData();
  elCartToggle.addEventListener('click', event => {
    event.preventDefault();

    if (window.Shopify.cartData.item_count > 0 && !window.location.href.includes('/cart')) {
      window.Shopify.toggleCart();
    }
  });
  elCartBg.addEventListener('click', () => {
    window.Shopify.toggleCart();
  });
  elContinueShopping.addEventListener('click', event => {
    event.preventDefault();
    window.Shopify.toggleCart('hide');
  });
});

window.Shopify.checkClarityInBasket = () => {
  let clarityWarningMessageEl = document.querySelectorAll(window.theme.selectors.minicart.clarityCompatibilityWarning);

  if (clarityWarningMessageEl) {
    let clarityCaseInBasket = false;
    let cart = window.Shopify.cartData.items;
    let item;

    for (item in cart) {
      if (cart[item].vendor === 'Clarity') {
        clarityCaseInBasket = true;
        break;
      }
    }

    clarityWarningMessageEl.forEach(warning => {
      if (clarityCaseInBasket) {
        warning.classList.remove('dn');
      } else {
        warning.classList.add('dn');
      }
    });
  }
};
/**
 * Add/remove cart dataLayer event on selected variant.
 */


const minicartDataLayerCartChange = (type, data) => {
  const addOrRemove = type === 'addToCart' ? 'add' : 'remove';
  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    event: type,
    ecommerce: {
      currencyCode: window.theme.shopCurrencyISO,
      [addOrRemove]: {
        products: [data]
      }
    }
  });
};