// Globals
const globs = {
  activeItem: null,
  activeStep: 0,
  breadcrumbs: {
    device: 'Device',
    brand: 'Brand',
    model: 'Model',
    offer: 'Offer'
  },
  collectionUrl: '',
  klaviyoId: '',
  signedUp: false,
  stepTitle: window.theme.strings.deviceOverlay.stepTitles.device
}; // Classes

const classes = {
  active: 'is-active',
  disabled: 'is-disabled',
  hidden: 'is-hidden',
  success: 'is-success'
}; // Selectors

const selectors = {
  // index featured
  featuredSlider: '[index="featured-slider"]',
  // index press
  pressGallery: '[index="press-gallery"]',
  pressQuotes: '[index="press-quotes"]',
  // device overlay
  do: {
    triggers: '[doverlay="trigger"]',
    stepContainer: '[doverlay="model-select"]',
    backBtn: '[doverlay="back-btn"]',
    breadcrumbs: '[doverlay="breadcrumbs"]',
    crumb: '[doverlay-crumb]',
    crumbTxt: '[doverlay-crumb-text]',
    stepTitle: '[doverlay="step-title"]',
    step: '[data-step]',
    nextSectionBtn: '[doverlay="next"]',
    section: '[data-section]',
    item: '[doverlay-item]',
    modelBtn: '[doverlay="model-btn"]',
    discountStep: '[doverlay="discount-step"]',
    form: '[doverlay="form"]',
    wantsDiscountBtn: '[doverlay="discount-btn"]',
    discountCodeContainer: '[doverlay="discount-code"]',
    discountCodeInput: '[doverlay="code-input"]',
    copyCodeBtn: '[doverlay="copy-code-btn"]',
    copyCodeText: '[doverlay="copy-code-text"]',
    discountShowProducts: '[doverlay="show-products-link"]',
    showEverything: '[doverlay="show-everything"]'
  }
}; // Node selectors

const nodes = {
  // index featured
  featuredSlider: document.querySelector(selectors.featuredSlider),
  // index press
  pressGallery: document.querySelector(selectors.pressGallery),
  pressQuotes: document.querySelector(selectors.pressQuotes),
  // device overlay
  do: {
    triggers: Array.from(document.querySelectorAll(selectors.do.triggers)),
    stepContainer: document.querySelector(selectors.do.stepContainer),
    backBtn: document.querySelector(selectors.do.backBtn),
    breadcrumbs: document.querySelector(selectors.do.breadcrumbs),
    crumb: Array.from(document.querySelectorAll(selectors.do.crumb)),
    stepTitle: document.querySelector(selectors.do.stepTitle),
    nextSectionBtn: Array.from(document.querySelectorAll(selectors.do.nextSectionBtn)),
    modelBtn: Array.from(document.querySelectorAll(selectors.do.modelBtn)),
    discountStep: document.querySelector(selectors.do.discountStep),
    form: document.querySelector(selectors.do.form),
    wantsDiscountBtn: document.querySelector(selectors.do.wantsDiscountBtn),
    discountCodeContainer: document.querySelector(selectors.do.discountCodeContainer),
    discountCodeInput: document.querySelector(selectors.do.discountCodeInput),
    copyCodeBtn: document.querySelector(selectors.do.copyCodeBtn),
    copyCodeText: document.querySelector(selectors.do.copyCodeText),
    discountShowProducts: document.querySelector(selectors.do.discountShowProducts),
    showEverything: document.querySelector(selectors.do.showEverything)
  }
}; // Flickity

const flkty = {}; // Helper functions

const helpers = {
  galleryHandler: (element, name, options) => {
    flkty[name] = new Flickity(element, options);
  }
};
/**
 * Initial setup for device overlay.
 */
const initialSetup = () => {
  globs.klaviyoId = nodes.do.form.dataset.id;
};
/**
 * Go to the next step of the model selector.
 */


const modelSelectorNextStep = button => {
  const parentItem = button.parentNode;
  const parentSection = button.closest(selectors.do.section).dataset.section;
  const nextSection = parentItem.querySelector(selectors.do.section).dataset.section;
  parentItem.classList.add(classes.active);
  nodes.do.backBtn.classList.add(classes.active);
  globs.activeItem = parentItem;
  globs.breadcrumbs[parentSection] = button.dataset.title;

  if (globs.breadcrumbs.device !== 'Phone') {
    globs.breadcrumbs.brand = 'Apple';
  }

  globs.activeStep = Number(parentItem.querySelector(selectors.do.step).dataset.step);
  updateBreadcrumbs();
  determineSectionTitleText(nextSection).then(() => {
    updateModelSectionTitles();
  });
};
/**
 * Go back a step in the model selector.
 */


const modelSelectorGoBack = () => {
  if (globs.activeStep === 0) {
    return;
  }

  if (globs.activeStep === 3) {
    globs.activeStep = 2;
    nodes.do.discountStep.classList.remove(classes.active);
    nodes.do.showEverything.classList.remove(classes.hidden);
    globs.breadcrumbs.model = window.theme.helpers.capitalize(globs.activeItem.querySelector(selectors.do.section).dataset.section);
  } else {
    const section = globs.activeItem.closest(selectors.do.section).dataset.section;
    globs.activeStep = Number(globs.activeItem.closest(selectors.do.step).dataset.step);
    globs.stepTitle = window.theme.strings.deviceOverlay.stepTitles[section];
    updateModelSectionTitles();
    globs.activeItem.classList.remove(classes.active);
    globs.activeItem = globs.activeItem.parentNode.closest(selectors.do.item);
    globs.breadcrumbs[section] = window.theme.helpers.capitalize(section);

    if (globs.breadcrumbs.device !== 'Phone') {
      globs.breadcrumbs.brand = 'Brand';
    }
  }

  updateBreadcrumbs();

  if (globs.activeStep === 0) {
    nodes.do.backBtn.classList.remove(classes.active);
  }
};
/**
 * Update the breadcrumbs as the user navigates through the model selector.
 */


const updateBreadcrumbs = () => {
  nodes.do.crumb.forEach(crumb => {
    crumb.classList.remove(classes.active);
    crumb.querySelector(selectors.do.crumbTxt).textContent = globs.breadcrumbs[crumb.getAttribute('doverlay-crumb')];
  });
  nodes.do.crumb[globs.activeStep].classList.add(classes.active);
};
/**
 * Decide which language string to match with based on what section the user is on.
 */


const determineSectionTitleText = section => {
  return new Promise(resolve => {
    const deviceType = window.theme.helpers.camelize(globs.breadcrumbs.device);
    let titleText = window.theme.strings.deviceOverlay.stepTitles[section];

    if (section === 'model') {
      titleText = window.theme.strings.deviceOverlay.stepTitles.model[deviceType];
    }

    globs.stepTitle = titleText;
    resolve(titleText);
  });
};
/**
 * Update the titles as the user navigates through the model selector.
 */


const updateModelSectionTitles = () => {
  nodes.do.stepTitle.textContent = globs.stepTitle;
};
/**
 * Once Klaviyo form has been submitted, show success message.
 */


const emailSignupSuccess = event => {
  const {
    formId,
    type
  } = event.detail;

  if (formId === globs.klaviyoId && type == 'close') {
    globs.signedUp = true;
    nodes.do.form.classList.remove(classes.active);
    nodes.do.discountCodeContainer.classList.add(classes.active);
    updateUrlWithDiscountCode();
  }
};
/**
 * Triggered when a device model is selected.
 */


const modelSelected = model => {
  globs.collectionUrl = model.dataset.link;
  globs.breadcrumbs.model = model.dataset.title;
  globs.activeStep = 3;
  nodes.do.discountShowProducts.href = globs.collectionUrl;
  nodes.do.discountStep.classList.add(classes.active);
  nodes.do.showEverything.classList.add(classes.hidden);
  updateBreadcrumbs();
};
/**
 * Select the discount code inside the input and copy it to clipboard.
 */


const copyDiscountCode = () => {
  nodes.do.discountCodeInput.select(); // for mobile devices

  nodes.do.discountCodeInput.setSelectionRange(0, 99999);
  document.execCommand('copy');
  nodes.do.copyCodeText.textContent = window.theme.strings.deviceOverlay.discount.codeCopied;
  nodes.do.discountCodeContainer.classList.add(classes.success);
  dataLayerEvent('deviceOverlayCopyCode');
};
/**
 * Update the show products button URL to automatically attach the discount code at checkout.
 */


const updateUrlWithDiscountCode = () => {
  const newUrl = `/discount/${window.theme.strings.deviceOverlay.discount.code}?redirect=${globs.collectionUrl}`;
  nodes.do.discountShowProducts.href = newUrl;
};
/**
 * Push action to the dataLayer.
 */


const dataLayerEvent = event => {
  window.dataLayer.push({
    event,
    currentStep: globs.activeStep
  });
};
/**
 * Wait for DOM to be ready.
 */


document.addEventListener('DOMContentLoaded', () => {
  initialSetup();
  nodes.do.triggers.forEach(trigger => {
    trigger.addEventListener('click', event => {
      event.preventDefault();
      const modal = document.querySelector(event.target.dataset.popup); // TODO: event needs adding in GTM
      //dataLayerEvent('shopNowClicked')

      window.theme.modalOpen(modal);
    });
  }); // progressing through model selector

  nodes.do.nextSectionBtn.forEach(button => {
    button.addEventListener('click', () => {
      modelSelectorNextStep(button);
    });
  }); // going back through overlay

  nodes.do.backBtn.addEventListener('click', () => {
    modelSelectorGoBack();
    dataLayerEvent('deviceOverlayBackButton');
  }); // selecting a model

  nodes.do.modelBtn.forEach(model => {
    model.addEventListener('click', () => {
      modelSelected(model);
    });
  }); // clicks wants discount button

  nodes.do.wantsDiscountBtn.addEventListener('click', event => {
    event.target.classList.add(classes.hidden);
    nodes.do.form.classList.add(classes.active);
  }); // copying the discount code

  nodes.do.copyCodeBtn.addEventListener('click', () => {
    copyDiscountCode();
  }); // klaviyo form submitted

  window.addEventListener('klaviyoForms', event => {
    emailSignupSuccess(event);
  }); // send datalayer event if user hasn't signed up for discount code.

  nodes.do.discountShowProducts.addEventListener('click', () => {
    if (globs.signedUp) {
      return;
    }

    dataLayerEvent('deviceOverlayDidntSignUp');
  }); // send datalayer event when user clicks show everything button.

  nodes.do.showEverything.addEventListener('click', () => {
    dataLayerEvent('deviceOverlayShowEverything');
  });
});
/**
 * Initiate featured products slider.
 */
const initFeaturedSlider = () => {
  helpers.galleryHandler(nodes.featuredSlider, 'featuredSlider', {
    cellAlign: 'center',
    lazyLoad: 1,
    contain: true,
    prevNextButtons: true,
    groupCells: true
  });
};

document.addEventListener('DOMContentLoaded', () => {
  if (nodes.featuredSlider) {
    initFeaturedSlider();
  }
});
/**
 * Initiate press sliders.
 */
const initPressSliders = () => {
  const quotesOptions = {
    autoPlay: 5000,
    cellAlign: 'center',
    contain: true,
    draggable: false,
    pageDots: false,
    pauseAutoPlayOnHover: false,
    prevNextButtons: false,
    wrapAround: true
  };
  const galleryOptions = {
    asNavFor: selectors.pressQuotes,
    autoPlay: 5000,
    cellAlign: 'center',
    contain: true,
    draggable: window.matchMedia('(max-width: 959px)').matches,
    groupCells: true,
    pauseAutoPlayOnHover: false,
    prevNextButtons: false
  };

  if (window.matchMedia('(max-width: 959px)').matches) {
    galleryOptions.asNavFor = false;
    quotesOptions.asNavFor = selectors.pressGallery;
  } // Initiate quotes slider


  helpers.galleryHandler(nodes.pressQuotes, 'pressQuotes', quotesOptions); // Init gallery slider

  helpers.galleryHandler(nodes.pressGallery, 'pressGallery', galleryOptions);
};

document.addEventListener('DOMContentLoaded', () => {
  if (nodes.pressQuotes && nodes.pressGallery) {
    initPressSliders();
  }
});